<div class="row">
  <div class="col-lg-12 mb-4">
    <div class="card">
      <div class="card-header">Accumulated data by country, sorted by confirmed cases</div>
      <div class="card-body">
        <div id="countries"><%= t('loading') %></div>
      </div>
    </div>
  </div>
</div>


<script>

    var country_query = new widgets.query(`
    query($from: ISO8601DateTime, $till: ISO8601DateTime, $limit: Int!, $offset: Int!) {
      offchain {
       covid {
          facts(date: {since: $from, till: $till}, options: {desc: "confirmed", limit: $limit, offset: $offset}){

            country {
              name
              populationTotal
              areaKm2
              iso2
            }

            confirmed
            recovered
            deaths
        }
       }
      }

    }`);

    widgets.callbacks({
        country_path: function(item){
            return 'covid/country/'+item.country.iso2 + '/' + item.country.name;
        },
        renderPopulation: function(item){
            var x = Math.round(item.country.populationTotal);
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        },
        renderArea: function(item){
            var x = Math.round(item.country.areaKm2);
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        },
    });

    new widgets.table('#countries', country_query, 'offchain.covid.facts', {
        title: 'Country stats',
        tableOptions: {
            title: [
                'Country', 'Confirmed Cases', 'Recovered', 'Deaths',
                'Total Population,<br>in thousands', 'Area,<br> sq.km.'
            ],
            data: [
                {
                    type: 'string-ellipsis',
                    path: 'country.name',
                    urlCallbackName: 'country_path'
                },
                {
                    type: 'count',
                    path: 'confirmed'
                },
                {
                    type: 'count',
                    path: 'recovered'
                },
                {
                    type: 'count',
                    path: 'deaths'
                },
                {
                    type: 'count',
                    renderCallbackName: 'renderPopulation'
                },
                {
                    type: 'count',
                    renderCallbackName: 'renderArea'
                },
            ]
        }
    });

    country_query.request({from: <%= @from.html_safe %>, till: <%= @till.html_safe %>, limit: 10});

    rr.change(function(start, end, clear){
        country_query.request({from: start, till: end, limit: 10, offset: 0});
    })

</script>